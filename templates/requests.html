<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Requests - BookBank</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <!-- Main Navigation Header -->
    <header>
        <h1>Your Requests - BookBank</h1>
        <nav>
            <ul class="nav">
                <li><a href="/">Home</a></li>
                <li><a href="/books">Your Books</a></li>
                <li><a href="/requests" aria-current="page">Your Requests</a></li>
                <li><a href="/logout">Log Out</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main>
        <section class="user-requests-section">
            <!-- Check if user has requests -->
            {% if requests and requests|length > 0 %}
                <h2>Your Book Requests</h2>
                <div class="requests-list">
                    <!-- Loop through each request -->
                    {% for r in requests %}
                    <div class="request-card">
                        <!-- Book Information -->
                        <div class="book-info">
                            <img src="{{ r.book.thumbnail }}" 
                                 alt="{{ r.book.title }}"
                                 onerror="this.onerror=null;this.src='../static/default.png';" 
                                 class="book-thumbnail">
                            
                            <div class="book-details">
                                <h3>{{ r.book.title }}</h3>
                                <p><strong>by</strong> {{ r.book.author }}</p>
                                <p><strong>Genre:</strong> {{ r.book.genre }}</p>
                                <p><strong>Condition:</strong> {{ r.book.condition }}</p>
                            </div>
                        </div>

                        <!-- Ownership and Request Information -->
                        <div class="ownership-info">
                            <p><strong>Owner:</strong> {{ r.book.owner.username }}</p>
                            <p><strong>Holder:</strong> {{ (r.book.holder.username if r.book.holder else r.book.owner.username) }}</p>
                            <p><strong>Requested on:</strong> {{ r.created_at[:10] }}</p>
                            <p><strong>Status:</strong> 
                                <span class="status-badge status-{{ r.status }}">{{ r.status }}</span>
                            </p>
                        </div>

                        <!-- Chat Section -->
                        <div class="chat-section">
                            <h4>Chat with Owner</h4>
                            
                            <!-- Chat Messages Display -->
                            <div id="chat-{{ r.id }}" class="chat-messages">
                                {% for m in r.messages %}
                                <div class="chat-message">
                                    <strong>{{ m.sender }}:</strong> 
                                    {{ m.message }} 
                                    <em>({{ m.created_at[11:16] }})</em>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Chat Input Form -->
                            <form onsubmit="return sendChat(event, {{ r.id }})" class="chat-form">
                                <input type="text" 
                                       id="msg-{{ r.id }}" 
                                       placeholder="Type a message" 
                                       required>
                                <button type="submit">Send</button>
                            </form>
                        </div>

                        <!-- Request Actions -->
                        <div class="request-actions">
                            <!-- Show return button only for accepted requests -->
                            {% if r.status == 'accepted' %}
                                <button onclick="initiateReturn({{ r.id }})" class="return-btn">
                                    Initiate Return
                                </button>
                            {% endif %}
                            
                            <!-- Delete request button -->
                            <button onclick="deleteRequest({{ r.id }})" class="delete-btn">
                                Delete Request
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- No requests message -->
                <div class="no-requests">
                    <h2>Your Book Requests</h2>
                    <p>You have not requested any books yet.</p>
                    <a href="/" class="browse-books-link">Browse available books</a>
                </div>
            {% endif %}
        </section>
    </main>

    <!-- JavaScript Files -->
    <!-- Common functions for chat and request handling -->
    <script src="static/js/common.js"></script>
</body>
</html>